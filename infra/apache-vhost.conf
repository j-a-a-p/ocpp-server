<VirtualHost *:80>
    ServerName aircokopen.nu
    ServerAlias www.aircokopen.nu
    
    # Redirect all HTTP traffic to HTTPS
    Redirect permanent / https://aircokopen.nu/
</VirtualHost>

<VirtualHost *:443>
    ServerName aircokopen.nu
    ServerAlias www.aircokopen.nu
    
    # SSL Configuration
    SSLEngine on
    SSLCertificateFile /etc/letsencrypt/live/aircokopen.nu/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/aircokopen.nu/privkey.pem
    
    # Security Headers
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains"
    Header always set X-Content-Type-Options nosniff
    Header always set X-Frame-Options DENY
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    
    # CORS Headers for API
    Header always set Access-Control-Allow-Origin "*"
    Header always set Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
    Header always set Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With"
    
    # Handle preflight requests
    RewriteEngine On
    RewriteCond %{REQUEST_METHOD} OPTIONS
    RewriteRule ^(.*)$ $1 [R=200,L]
    
    # WebSocket proxy for OCPP connections
    ProxyPass "/ws" "ws://localhost:9000/"
    ProxyPassReverse "/ws" "ws://localhost:9000/"
    
    # API proxy for FastAPI endpoints
    ProxyPass "/api/" "http://localhost:8000/"
    ProxyPassReverse "/api/" "http://localhost:8000/"
    
    # Optional: Proxy specific API routes at root level
    ProxyPass "/owners/" "http://localhost:8000/owners/"
    ProxyPassReverse "/owners/" "http://localhost:8000/owners/"
    
    ProxyPass "/cards/" "http://localhost:8000/cards/"
    ProxyPassReverse "/cards/" "http://localhost:8000/cards/"
    
    # Static files (if any)
    DocumentRoot /var/www/html
    
    # Logging
    ErrorLog ${APACHE_LOG_DIR}/aircokopen.nu-error.log
    CustomLog ${APACHE_LOG_DIR}/aircokopen.nu-access.log combined
    
    # Proxy settings
    ProxyPreserveHost On
    ProxyRequests Off
    
    # Timeout settings for long-running requests
    ProxyTimeout 300
    ProxyBadHeader Ignore
</VirtualHost> 